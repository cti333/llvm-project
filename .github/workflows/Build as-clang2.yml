name: Build as-clangd & as-clang-format

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 支持手动触发编译

jobs:
  build:
    runs-on: windows-latest
    # 设置合理的超时，防止死循环
    timeout-minutes: 120 

    steps:
      - name: Checkout llvm-project
        uses: actions/checkout@v4

      # 1. 设置 ccache 缓存环境
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: "2G"
          # 使用特定的 Key，确保 clangd 编译能复用之前的 .obj
          key: ${{ runner.os }}-as-clangd-cache
          variant: ccache

      # 2. 安装 Ninja 构建工具 (比 MSBuild 快得多)
      - name: Install Ninja
        run: choco install ninja

      # 3. 配置 CMake (关键参数解释见下方)
      - name: Configure CMake
        run: |
          cmake -S llvm -B build `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" `
            -DLLVM_TARGETS_TO_BUILD="X86" `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DLLVM_USE_CRT_RELEASE=MT `
            -DLLVM_ENABLE_ASSERTIONS=OFF `
            -DLLVM_INCLUDE_TESTS=OFF `
            -DLLVM_DISTRIBUTION_COMPONENTS="clangd;clang-format"

      # 4. 执行编译 (仅编译目标组件)
      - name: Build Targets
        run: |
          cmake --build build --target clangd clang-format

      # 5. 整理产物并上传
      - name: Archive Production
        run: |
          mkdir release-bin
          copy build\bin\clangd.exe release-bin\as-clangd.exe
          copy build\bin\clang-format.exe release-bin\as-clang-format.exe

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: as-tools-windows
          path: release-bin/
