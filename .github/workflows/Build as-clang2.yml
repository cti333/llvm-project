name: Build as-clangd & as-clang-format

on:
  # push: branches: [ main ]  # 已禁用自动触发
  workflow_dispatch: # 启用手动触发编译

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120 

    steps:
      - name: Checkout llvm-project
        uses: actions/checkout@v4

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: "2G"
          key: ${{ runner.os }}-as-clangd-cache
          variant: ccache

      - name: Install Ninja
        run: choco install ninja

      - name: Configure CMake
        run: |
          cmake -S llvm -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" `
            -DLLVM_TARGETS_TO_BUILD="X86" `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DLLVM_USE_CRT_RELEASE=MT `
            -DLLVM_BUILD_STATIC=ON `
            -DLLVM_ENABLE_ASSERTIONS=OFF `
            -DLLVM_INCLUDE_TESTS=OFF `
            -DLLVM_DISTRIBUTION_COMPONENTS="clangd;clang-format"

      - name: Build Targets
        run: |
          cmake --build build --target clangd clang-format

      - name: Archive Production
        run: |
          if (!(Test-Path release-bin)) { mkdir release-bin }
          copy build\bin\clangd.exe release-bin\as-clangd.exe
          copy build\bin\clang-format.exe release-bin\as-clang-format.exe

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: as-tools-windows
          path: release-bin/
