name: Build AngelScript Clang Tools

on:
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    runs-on: windows-2022
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 1. 安装 ccache 工具
      - name: Install ccache
        run: choco install ccache

      # 2. 配置 ccache 缓存
      - name: ccache Cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      # 3. 配置 CMake (使用 VS 2022 生成器 + 原生 MSVC 环境)
      - name: Configure CMake
        shell: pwsh
        run: |
          $env:CCACHE_DIR = "$(Get-Location)/.ccache"
          cmake -S llvm -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" `
            -DLLVM_TARGETS_TO_BUILD="X86" `
            -DLLVM_USE_CRT_RELEASE=MT `
            -DCMAKE_MSVC_RUNTIME_LIBRARY="MultiThreaded" `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache `
            -DLLVM_ENABLE_ASSERTIONS=OFF `
            -DLLVM_INCLUDE_TESTS=OFF `
            -DLLVM_INCLUDE_BENCHMARKS=OFF

      # 4. 构建目标 (显式指定 Release 配置)
      - name: Build Targets
        shell: pwsh
        run: |
          $env:CCACHE_DIR = "$(Get-Location)/.ccache"
          # 编译特定的二进制文件
          cmake --build build --config Release --target clang-format clangd --parallel 2

      # 5. 重命名并准备产物
      - name: Prepare Artifacts
        shell: pwsh
        run: |
          if (!(Test-Path "dist")) { mkdir "dist" }
          # 将原始文件重命名并移动到 dist 文件夹
          copy build/Release/bin/clang-format.exe dist/as-clang-format.exe
          copy build/Release/bin/clangd.exe dist/as-clangd.exe

      # 6. 上传产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: as-clang-tools-windows
          path: dist/ # 直接上传 dist 文件夹下的重命名文件